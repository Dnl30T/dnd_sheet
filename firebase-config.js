// Configura√ß√£o do Firebase
// Substitua pelos seus dados do Firebase Console
const firebaseConfig = {
    apiKey: "AIzaSyARSykuZFgVtH-S1JX1k58CgC1OKBLBvdM",
    authDomain: "dndsheet-2b865.firebaseapp.com",
    projectId: "dndsheet-2b865",
    storageBucket: "dndsheet-2b865.firebasestorage.app",
    messagingSenderId: "660045034554",
    appId: "1:660045034554:web:5c017a7b999150048bf103",
    measurementId: "G-50N0WMT2BB"
};


// Inicializar Firebase
console.log('üîß Iniciando Firebase com Firestore...');
console.log('üìã Configura√ß√£o:', firebaseConfig);

try {
    firebase.initializeApp(firebaseConfig);
    console.log('‚úÖ Firebase inicializado com sucesso!');
} catch (error) {
    console.error('‚ùå Erro ao inicializar Firebase:', error);
}

// Refer√™ncias do Firestore
const db = firebase.firestore();
const charactersCollection = db.collection('characters');

// Teste de conex√£o inicial para Firestore
console.log('üîç Testando conex√£o com Firestore...');

// Para Firestore, vamos fazer um teste simples
db.enableNetwork().then(() => {
    console.log('‚úÖ Conectado ao Firebase Firestore!');
    
    // Mostrar notifica√ß√£o visual se a fun√ß√£o existir
    if (typeof showNotification === 'function') {
        showNotification('Firebase Firestore conectado com sucesso!', 'success');
    }
    
    // Adicionar indicador visual na p√°gina
    addFirebaseStatusIndicator(true);
}).catch((error) => {
    console.error('‚ùå Erro ao conectar com Firestore:', error);
    
    if (typeof showNotification === 'function') {
        showNotification('Firebase Firestore offline - usando dados locais', 'warning');
    }
    
    addFirebaseStatusIndicator(false);
});

// Fun√ß√£o para adicionar indicador visual de status
function addFirebaseStatusIndicator(connected) {
    // Verificar se jQuery est√° dispon√≠vel
    if (typeof $ === 'undefined') {
        console.log('‚ö†Ô∏è jQuery n√£o est√° dispon√≠vel ainda, pulando indicador visual');
        return;
    }
    
    // Remove indicador existente
    $('#firebase-status').remove();
    
    const statusHtml = `
        <div id="firebase-status" class="fixed top-4 right-4 z-50 px-3 py-2 rounded-md text-sm font-medium ${
            connected 
                ? 'bg-green-100 text-green-800 border border-green-200' 
                : 'bg-yellow-100 text-yellow-800 border border-yellow-200'
        }">
            <span class="mr-2">${connected ? 'üü¢' : 'üü°'}</span>
            Firestore: ${connected ? 'Conectado' : 'Offline'}
        </div>
    `;
    
    $('body').append(statusHtml);
    
    // Auto-remover ap√≥s 5 segundos se conectado
    if (connected) {
        setTimeout(() => {
            $('#firebase-status').fadeOut();
        }, 5000);
    }
}

// Utilit√°rios do Firestore
const FirebaseUtils = {
    // Salvar personagem no Firestore
    async saveCharacter(characterData) {
        console.log('üíæ Tentando salvar personagem no Firestore:', characterData.name);
        console.log('üìä Dados completos:', characterData);
        
        try {
            if (!characterData.name || characterData.name.trim() === '') {
                throw new Error('Nome do personagem √© obrigat√≥rio');
            }

            const characterKey = this.sanitizeKey(characterData.name);
            console.log('üîë Chave sanitizada:', characterKey);
            
            // Adicionar timestamp
            characterData.lastUpdated = firebase.firestore.Timestamp.now();
            characterData.created = characterData.created || firebase.firestore.Timestamp.now();
            
            console.log('üì° Enviando para Firestore...');
            await charactersCollection.doc(characterKey).set(characterData);
            console.log('‚úÖ Personagem salvo no Firestore com sucesso!');
            
            // Salvar no localStorage tamb√©m como backup
            localStorage.setItem('dnd-character-data', JSON.stringify(characterData));
            console.log('üíΩ Backup salvo no localStorage');
            
            const url = this.getCharacterUrl(characterKey);
            console.log('üîó URL gerada:', url);
            
            return {
                success: true,
                message: 'Personagem salvo com sucesso!',
                url: url
            };
        } catch (error) {
            console.error('‚ùå Erro ao salvar personagem:', error);
            console.error('üìã Stack trace:', error.stack);
            return {
                success: false,
                message: 'Erro ao salvar personagem: ' + error.message
            };
        }
    },

    // Carregar personagem do Firestore
    async loadCharacter(characterName) {
        console.log('üìñ Tentando carregar personagem do Firestore:', characterName);
        
        try {
            const characterKey = this.sanitizeKey(characterName);
            console.log('üîë Chave sanitizada para busca:', characterKey);
            
            console.log('üì° Buscando no Firestore...');
            const doc = await charactersCollection.doc(characterKey).get();
            
            if (doc.exists) {
                const data = doc.data();
                console.log('‚úÖ Personagem encontrado!');
                console.log('üìä Dados carregados:', data);
                
                // Converter timestamps para formato leg√≠vel
                if (data.lastUpdated && data.lastUpdated.toDate) {
                    data.lastUpdated = data.lastUpdated.toDate().getTime();
                }
                if (data.created && data.created.toDate) {
                    data.created = data.created.toDate().getTime();
                }
                
                return {
                    success: true,
                    data: data
                };
            } else {
                console.log('‚ùå Personagem n√£o encontrado no Firestore');
                return {
                    success: false,
                    message: 'Personagem n√£o encontrado'
                };
            }
        } catch (error) {
            console.error('‚ùå Erro ao carregar personagem:', error);
            console.error('üìã Stack trace:', error.stack);
            return {
                success: false,
                message: 'Erro ao carregar personagem: ' + error.message
            };
        }
    },

    // Listar todos os personagens do Firestore
    async listCharacters() {
        console.log('üìã Listando todos os personagens do Firestore...');
        
        try {
            console.log('üì° Buscando lista no Firestore...');
            const querySnapshot = await charactersCollection.orderBy('lastUpdated', 'desc').get();
            const characters = [];
            
            if (!querySnapshot.empty) {
                console.log('üìä Dados encontrados, processando...');
                
                querySnapshot.forEach((doc) => {
                    const character = doc.data();
                    const characterInfo = {
                        key: doc.id,
                        name: character.name,
                        classLevel: character.classLevel,
                        lastUpdated: character.lastUpdated ? character.lastUpdated.toDate().getTime() : Date.now(),
                        url: this.getCharacterUrl(doc.id)
                    };
                    
                    characters.push(characterInfo);
                    console.log('üë§ Personagem adicionado:', characterInfo);
                });
                
                console.log(`‚úÖ Total de ${characters.length} personagens encontrados`);
                
                return {
                    success: true,
                    data: characters
                };
            } else {
                console.log('üì≠ Nenhum personagem encontrado no Firestore');
                return {
                    success: true,
                    data: []
                };
            }
        } catch (error) {
            console.error('‚ùå Erro ao listar personagens:', error);
            console.error('üìã Stack trace:', error.stack);
            return {
                success: false,
                message: 'Erro ao listar personagens: ' + error.message
            };
        }
    },

    // Limpar nome do personagem para usar como chave
    sanitizeKey(name) {
        return name
            .toLowerCase()
            .trim()
            .replace(/[^a-z0-9\s]/g, '')
            .replace(/\s+/g, '-')
            .substring(0, 50);
    },

    // Gerar URL do personagem
    getCharacterUrl(characterKey) {
        const baseUrl = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '');
        return `${baseUrl}/personagens/${characterKey}`;
    },

    // Verificar se personagem existe no Firestore
    async characterExists(characterName) {
        console.log('üîç Verificando se personagem existe no Firestore:', characterName);
        
        try {
            const characterKey = this.sanitizeKey(characterName);
            console.log('üîë Chave para verifica√ß√£o:', characterKey);
            
            const doc = await charactersCollection.doc(characterKey).get();
            const exists = doc.exists;
            
            console.log(exists ? '‚úÖ Personagem existe' : '‚ùå Personagem n√£o existe');
            return exists;
        } catch (error) {
            console.error('‚ùå Erro ao verificar personagem:', error);
            return false;
        }
    },

    // Fun√ß√£o de teste completo do Firestore
    async testFirebaseConnection() {
        console.log('üß™ === TESTE COMPLETO DO FIRESTORE ===');
        
        try {
            // 0. Verificar se o Firestore est√° configurado
            console.log('0Ô∏è‚É£ Verificando configura√ß√£o do Firestore...');
            if (!firebaseConfig.projectId) {
                throw new Error('projectId n√£o configurado no firebaseConfig');
            }
            console.log('‚úÖ projectId configurado:', firebaseConfig.projectId);
            
            // 1. Teste de conectividade b√°sica
            console.log('1Ô∏è‚É£ Testando conectividade b√°sica do Firestore...');
            const testDoc = db.collection('test').doc('connection-test');
            await testDoc.set({ 
                timestamp: firebase.firestore.Timestamp.now(), 
                test: true 
            });
            console.log('‚úÖ Escrita de teste bem-sucedida no Firestore');
            
            // 2. Teste de leitura
            console.log('2Ô∏è‚É£ Testando leitura...');
            const doc = await testDoc.get();
            if (doc.exists) {
                console.log('‚úÖ Leitura de teste bem-sucedida:', doc.data());
            }
            
            // 3. Limpar teste
            await testDoc.delete();
            console.log('‚úÖ Limpeza de teste conclu√≠da');
            
            // 4. Teste da cole√ß√£o de personagens
            console.log('3Ô∏è‚É£ Testando cole√ß√£o de personagens...');
            const charactersSnapshot = await charactersCollection.get();
            const count = charactersSnapshot.size;
            console.log(`‚úÖ Cole√ß√£o OK - ${count} personagens na base`);
            
            // 5. Teste de permiss√µes
            console.log('4Ô∏è‚É£ Testando permiss√µes...');
            const permissionTest = db.collection('permission-test').doc('test');
            await permissionTest.set({ test: true });
            await permissionTest.delete();
            console.log('‚úÖ Permiss√µes OK - pode ler e escrever no Firestore');
            
            console.log('üéâ === TODOS OS TESTES DO FIRESTORE PASSARAM ===');
            
            if (typeof showNotification === 'function') {
                showNotification('Firestore: Todos os testes passaram! üéâ', 'success');
            }
            
            return true;
        } catch (error) {
            console.error('‚ùå === TESTE DO FIRESTORE FALHOU ===');
            console.error('Erro:', error.message);
            console.error('Detalhes:', error);
            
            // Diagn√≥sticos espec√≠ficos para Firestore
            if (error.message.includes('projectId')) {
                console.error('üîß SOLU√á√ÉO: Verifique se projectId est√° correto na configura√ß√£o');
            } else if (error.message.includes('permission') || error.code === 'permission-denied') {
                console.error('üîß SOLU√á√ÉO: Configure as regras de seguran√ßa do Firestore');
                console.error('üìã Regras sugeridas para teste:');
                console.error('rules_version = "2";');
                console.error('service cloud.firestore {');
                console.error('  match /databases/{database}/documents {');
                console.error('    match /{document=**} {');
                console.error('      allow read, write: if true;');
                console.error('    }');
                console.error('  }');
                console.error('}');
            } else if (error.message.includes('network') || error.code === 'unavailable') {
                console.error('üîß SOLU√á√ÉO: Verifique sua conex√£o com a internet');
            } else if (error.code === 'not-found') {
                console.error('üîß SOLU√á√ÉO: Verifique se o Firestore est√° habilitado no projeto');
            }
            
            if (typeof showNotification === 'function') {
                showNotification('Firestore: Teste falhou - ' + error.message, 'error');
            }
            
            return false;
        }
    }
};

// Executar teste autom√°tico ap√≥s 3 segundos (aumentado para dar tempo do jQuery carregar)
setTimeout(() => {
    console.log('‚è∞ Executando teste autom√°tico do Firestore...');
    FirebaseUtils.testFirebaseConnection();
}, 3000);

// Adicionar fun√ß√£o de teste manual no objeto window para debug no console
window.testFirebase = () => {
    console.log('üîß Executando teste manual do Firestore...');
    return FirebaseUtils.testFirebaseConnection();
};

// Exportar para uso global
window.FirebaseUtils = FirebaseUtils;

// Log final
console.log('üîß Firebase-config.js carregado completamente para Firestore!');
console.log('üí° Use testFirebase() no console para testar manualmente');
console.log('üìã Se der erro de permiss√£o, configure as regras do Firestore para:');
console.log(`rules_version = "2";
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}`);
